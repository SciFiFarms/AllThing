#!/usr/bin/env bash
. init.sh

source ${TECHNOCORE_LIB}/compose.sh

# $1: The compose file.
generate_secrets(){
    # Gen secrets from services.
    for script in $TECHNOCORE_SERVICES/*/secrets.sh; do
        if [ -f "$script" ]; then
            source $script "$1"
        else
            echo "Could not find $script script."
        fi
    done

    # TODO: It would be nice to put this into a function. Look at 
    #       generate_password_for in compose.sh as well.
    # Gen any admin passwords
    for secret in $(echo "$1" | yq read - 'secrets.*.name') ;do
        if [ "$secret" = "-" ]; then
            continue
        fi
        
        if docker secret ls | grep -w $secret > /dev/null; then
            continue # Secret already exists.
        fi

        if [[ "$secret" =~ (${STACK_NAME}_.*_admin_password) ]]; then
            secret=${BASH_REMATCH[1]}
            echo "Creating secret $secret"
            # TODO: This should use a centralized create secret call.
            echo -e "$(generate_password 32)" | docker secret create ${secret} - > /dev/null
        fi
    done

    # Gen any non existent secrets
    for secret in $(echo "$1" | yq read - 'secrets.*.name') ;do
        if [ "$secret" = "-" ]; then
            continue
        fi
        
        #echo -e "\n\n\nMy secret: $secret"
        if ! docker secret ls | grep -w $secret > /dev/null; then
            echo "Creating secret $secret with default value \"Not yet set.\""
            # TODO: This should use a centralized create secret call.
            echo -e "Not yet set." | docker secret create ${secret} - > /dev/null
        fi
    done
}

# TODO: Move this to a sidecar. 
## Update DuckDNS entry with the internal IP address. 
#ip=$(ping -c 1 ${SERVER_HOSTNAME} | awk -F '[()]' '/PING/{print $2}')
## How to silence curl: https://unix.stackexchange.com/questions/196549/hide-curl-output
#echo url="https://www.duckdns.org/update?domains=${DUCKNS_SUBDOMAIN}&token=${DUCKDNS_TOKEN}&ip=${ip}" | curl -s -K - > /dev/null

generate_complete_compose

generate_secrets "$COMPLETE_COMPOSE"

echo "$COMPLETE_COMPOSE" | docker stack deploy --compose-file - ${STACK_NAME:-technocore}
